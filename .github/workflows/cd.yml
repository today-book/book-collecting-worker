name: CD - Deploy book-collecting-worker

on:
  push:
    branches: ["main"]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: today-book/book-collecting-worker
  VERSION: latest

jobs:
  deploy:
    name: Build Docker Image and Deploy EC2
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    environment: deploy

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: gradle

      - name: Configure Gradle for GitHub Packages
        run: |
          mkdir -p ~/.gradle
          cat >> ~/.gradle/gradle.properties <<EOF
          gpr.user=${{ github.actor }}
          gpr.key=${{ secrets.COMMON_CORE_READ_PACKAGES_TOKEN }}
          EOF

      - name: Build bootJar
        run: |
          chmod +x gradlew
          ./gradlew bootJar -x test --no-daemon

      - name: Log into container registry (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: seongjjun
          password: ${{ secrets.BOOK_COLLECTING_WORKER_GHCR_PUSH_TOKEN }}

      - name: Build & Push container image (latest + sha)
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
          docker build -t "${IMAGE}:${{ env.VERSION }}" -t "${IMAGE}:${GITHUB_SHA}" .
          docker push "${IMAGE}:${{ env.VERSION }}"
          docker push "${IMAGE}:${GITHUB_SHA}"

      - name: Executing remote ssh commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEV_REMOTE_IP }}
          username: ${{ secrets.DEV_REMOTE_USER }}
          key: ${{ secrets.DEV_REMOTE_PRIVATE_KEY }}
          port: ${{ secrets.DEV_REMOTE_SSH_PORT }}
          script: |
            set -euo pipefail

            # GitHub Actions에서 만든 이미지 태그(서버도 이 이미지를 pull)
            IMAGE_URI="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION }}"

            # EC2 서버에 미리 만들어 둔 env 파일 경로(확정된 절대경로)
            BASE_DIR="/home/ubuntu/app/book-collecting-worker"
            DEPLOY_ENV_FILE="${BASE_DIR}/deploy.env"
            APP_ENV_FILE="${BASE_DIR}/app.env"

            if [ ! -f "${DEPLOY_ENV_FILE}" ]; then
              echo "deploy.env 파일이 없습니다: ${DEPLOY_ENV_FILE}"
              exit 1
            fi

            # deploy.env 로드: CONTAINER_NAME, APP_PORT, DOCKER_NETWORK, GHCR_USERNAME, GHCR_PAT, (선택) SPRING_PROFILES_ACTIVE
            set -a
            . "${DEPLOY_ENV_FILE}"
            set +a

            : "${CONTAINER_NAME:?deploy.env에 CONTAINER_NAME이 필요합니다}"
            : "${APP_PORT:?deploy.env에 APP_PORT가 필요합니다}"
            : "${DOCKER_NETWORK:?deploy.env에 DOCKER_NETWORK가 필요합니다}"
            : "${GHCR_USERNAME:?deploy.env에 GHCR_USERNAME이 필요합니다}"
            : "${GHCR_PAT:?deploy.env에 GHCR_PAT가 필요합니다}"

            # 없으면 기본값(prod)
            SPRING_PROFILES_ACTIVE="${SPRING_PROFILES_ACTIVE:-prod}"

            echo "배포 시작: ${IMAGE_URI}"

            sudo docker stop "${CONTAINER_NAME}" || true
            sudo docker rm "${CONTAINER_NAME}" || true

            echo "GHCR 로그인 (서버 deploy.env 값 사용)"
            echo "${GHCR_PAT}" | sudo docker login "${{ env.REGISTRY }}" -u "${GHCR_USERNAME}" --password-stdin

            echo "이미지 Pull"
            sudo docker pull "${IMAGE_URI}"

            echo "도커 네트워크 확인"
            sudo docker network inspect "${DOCKER_NETWORK}" >/dev/null 2>&1 || sudo docker network create "${DOCKER_NETWORK}"

            echo "컨테이너 실행"
            if [ -f "${APP_ENV_FILE}" ]; then
              sudo docker run -d --name "${CONTAINER_NAME}" \
                --restart unless-stopped \
                --network "${DOCKER_NETWORK}" \
                -p "${APP_PORT}:9001" \
                --env-file "${APP_ENV_FILE}" \
                "${IMAGE_URI}"
            else
              sudo docker run -d --name "${CONTAINER_NAME}" \
                --restart unless-stopped \
                --network "${DOCKER_NETWORK}" \
                -p "${APP_PORT}:9001" \
                -e SPRING_PROFILES_ACTIVE="${SPRING_PROFILES_ACTIVE}" \
                "${IMAGE_URI}"
            fi

            sudo docker image prune -f
